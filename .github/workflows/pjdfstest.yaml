name: pjdfstest
on: [push, pull_request]
env:
  CARGO_TERM_COLOR: always
jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - name: Check out the repo
        uses: actions/checkout@v2
      - name: Build Docker Image
        uses: docker/build-push-action@v1
        env:
          DOCKER_BUILDKIT: 1
        with:
          push: false
          tags: ci
      - name: Build pjdfstest
        run: |
          git clone https://github.com/pjd/pjdfstest.git
          cd pjdfstest
          autoreconf -ifs
          ./configure
          make pjdfstest
      - name: Test
        run: |
          docker-compose up -d
          cd ./mnt
          until stat . | grep 65536
          do
            echo "Try again"
            sleep 1
          done
          sudo prove -rv $GITHUB_WORKSPACE/pjdfstest/tests

